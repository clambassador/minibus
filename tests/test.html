<html>

<head>
<body>
<canvas id="pad" width="200" height="200"></canvas>
<script>

function http_get(url) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.overrideMimeType('text/plain');
    xmlhttp.open("GET", url, false);
    xmlhttp.send(null);
    return xmlhttp.responseText;
}

function fresh() {
		return "t=" + new Date().getTime();
}

document.onkeydown = function(evt) {
    evt = evt || window.event;
		ret = http_get('/%%cid%%/set/key?val=' + evt.keyCode + '&' + fresh());
    if (ret != '') {
      window.location.pathname = "/?" + fresh();
    }
		// TODO: handle shifts and so forth: evt.ctrlKey
    render();
}

function render() {
		data = http_get('/%%cid%%/get/screen?' + fresh());
		width = http_get('/%%cid%%/get/screen_width?' + fresh());
		height = http_get('/%%cid%%/get/screen_height?' + fresh());
    if (old_height != height || old_width != width) {
      old_width = width;
      old_height = height;
      old_data = data;
      full_render()
    } else {
      partial_render(data);
      old_data = data;
    }
}

function partial_render(data) {
    for (i = 0; i < old_height; ++i) {
      for (j = 0; j < old_width; ++j) {
        pos = (i * old_width) + j;
        if (old_data.charAt(pos) != data.charAt(pos)) {
          clear_char(i + 1, j + 1);
          render_char(i + 1, j + 1, ''+ data.charAt((i * old_width) + j));
        }
      }
    }
}

function full_render() {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    for (i = 0; i < old_height; ++i) {
      for (j = 0; j < old_width; ++j) {
        render_char(i + 1, j + 1, ''+old_data.charAt((i * old_width) + j));
      }
    }
}

var canvas = document.getElementById("pad");
var ctx = canvas.getContext("2d");

canvas.width = .9 * window.innerWidth;
canvas.height = .9 * window.innerHeight;

var old_height = 0;
var old_width = 0;

var col_width = 10;
var row_height = 18;

function clear_char(row, col) {
  ctx.fillStyle = "black";
  ctx.fillRect((col) * col_width, (row - 1) * row_height,
                col_width, row_height);
}

function render_char(row, col, val) {
  ctx.font = "16px monospace";
  ctx.fillStyle = "white";
  ctx.fillText(val, col * col_width, row * row_height - 4);
}

render();
</script>


</body>
</html>
